<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Negotiate‑LLM Chat</title>
  <style>
    body  { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 1rem; }
    #chat { height: 450px; overflow-y: auto; border: 1px solid #ccc; padding:.5rem; margin-bottom: 1rem; }
    .user   { color:#1a73e8;  margin-bottom:.5rem; white-space:pre-wrap; }
    .assist { color:#188038;   margin-bottom:.5rem; white-space:pre-wrap; }
    textarea{ width:100%; }
  </style>
</head>
<body>
  <h2 id="banner">Loading…</h2>
  <div id="chat"></div>
  <textarea id="input" rows="3" placeholder="Type a message & press Enter"></textarea>
  <button id="send">Send</button>

  <script>
  const API  = 'https://still-glade-4d20.curtisgenereux01.workers.dev';
  const slug = new URLSearchParams(location.search).get('slug');
  if (!slug) { alert('Missing slug'); throw new Error('missing slug'); }

  const convo = [];      // running conversation
  const box   = document.getElementById('chat');

  function render() {
    box.innerHTML = '';
    convo.forEach(m => {
      if (m.role === 'system') return; // hide system/internal msgs
      const div = document.createElement('div');
      div.className = m.role === 'assistant' ? 'assist' : 'user';
      div.textContent = `${m.role === 'assistant' ? 'AI' : 'You'}: ${m.content}`;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }

  /* 1. Fetch payload and generate first AI message */
  fetch(`${API}/payload/${slug}`)
    .then(r => r.json())
    .then(async data => {
      document.getElementById('banner').textContent = `Chat with ${data.to || 'Recipient'}`;

      const sys = `You are an expert negotiator hired by ${data.from || 'someone'}.\n\n`+
                  `PRIVATE CONTEXT (not visible to ${data.to || 'the recipient'}):\n`+
                  `${data.context}\n\n`+
                  `Objective: ${data.rq}.\n`+
                  `Do NOT reveal the private context. Begin with a friendly opening message addressing ${data.to}.`;
      convo.push({ role:'system', content: sys });

      // ask OpenAI for opening message
      const res = await fetch(API, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ model:'o3', messages: convo })
      });
      const reply = (await res.json()).choices[0].message.content.trim();
      convo.push({ role:'assistant', content: reply });
      render();
    })
    .catch(err => alert(err.message));

  /* 2. send helper */
  async function send() {
    const input = document.getElementById('input');
    const txt = input.value.trim();
    if (!txt) return;
    input.value = '';
    convo.push({ role:'user', content: txt });
    render();

    const r = await fetch(API, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ model:'o3', messages: convo })
    });
    if (!r.ok) return alert(await r.text());
    const reply = (await r.json()).choices[0].message.content.trim();
    convo.push({ role:'assistant', content: reply });
    render();
  }

  document.getElementById('send').onclick = send;
  document.getElementById('input').addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
  });
  </script>
</body>
</html>
